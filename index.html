/**
 * 學校 CRM 後台（兒美 v1.0）
 *
 * Sheets:
 * 1) schools（主資料：可覆蓋更新）
 * 2) versions（版本表：可後台調整分類/書名/順序）
 * 3) updates（進度歷史：每次新增一筆）
 *
 * 安全：
 * - 前端送 token，後端用 TOKEN 驗證，不一致就回 Unauthorized
 *
 * schools 欄位（第一列標題）：
 * SchoolKey | SchoolName | Address | ContactName | ContactTitle | Phone |
 * VersionsJSON | VersionOther | LastUpdated | LastModifiedBy
 *
 * updates 欄位：
 * Timestamp | SchoolKey | SchoolName | SalesPerson | Note | Source
 *
 * versions 欄位：
 * Category | Item | CategoryOrder | ItemOrder
 */

const TOKEN = "abc123";

const SHEET_SCHOOLS = "schools";
const SHEET_UPDATES = "updates";
const SHEET_VERSIONS = "versions";

function doGet() {
  return ContentService.createTextOutput("School CRM backend is running.");
}

function doPost(e) {
  try {
    const body = (e && e.postData && e.postData.contents) ? e.postData.contents : "{}";
    const p = JSON.parse(body);

    if (!p || p.token !== TOKEN) return json_({ ok: false, error: "Unauthorized" });

    ensureSheets_();

    const action = String(p.action || "");
    if (action === "searchSchools") return searchSchools_(p);
    if (action === "getSchool") return getSchool_(p);
    if (action === "updateSchool") return updateSchool_(p);
    if (action === "createSchool") return createSchool_(p);
    if (action === "getVersionOptions") return getVersionOptions_();

    return json_({ ok: false, error: "Unknown action: " + action });
  } catch (err) {
    return json_({ ok: false, error: String(err) });
  }
}

function ensureSheets_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let sh = ss.getSheetByName(SHEET_SCHOOLS);
  if (!sh) sh = ss.insertSheet(SHEET_SCHOOLS);

  let up = ss.getSheetByName(SHEET_UPDATES);
  if (!up) up = ss.insertSheet(SHEET_UPDATES);

  let vs = ss.getSheetByName(SHEET_VERSIONS);
  if (!vs) vs = ss.insertSheet(SHEET_VERSIONS);

  const hSchools = [
    "SchoolKey","SchoolName","Address","ContactName","ContactTitle","Phone",
    "VersionsJSON","VersionOther",
    "LastUpdated","LastModifiedBy"
  ];
  const hUpdates = ["Timestamp","SchoolKey","SchoolName","SalesPerson","Note","Source"];
  const hVersions = ["Category","Item","CategoryOrder","ItemOrder"];

  if (sh.getLastRow() === 0) sh.appendRow(hSchools);
  if (up.getLastRow() === 0) up.appendRow(hUpdates);
  if (vs.getLastRow() === 0) vs.appendRow(hVersions);

  // 補齊 schools 欄位
  const existing = sh.getRange(1, 1, 1, sh.getLastColumn()).getValues()[0].map(String);
  hSchools.forEach((h) => {
    if (existing.indexOf(h) === -1) {
      sh.insertColumnAfter(sh.getLastColumn());
      sh.getRange(1, sh.getLastColumn()).setValue(h);
      existing.push(h);
    }
  });
}

function json_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function fmt_(d) {
  return Utilities.formatDate(new Date(d), Session.getScriptTimeZone(), "yyyy-MM-dd HH:mm");
}

function idx_(headers, name) {
  const i = headers.indexOf(name);
  return i >= 0 ? i : -1;
}

/** 搜尋學校：用 key/name/address 模糊比對 */
function searchSchools_(p) {
  const q = String(p.q || "").trim().toLowerCase();
  if (!q) return json_({ ok: true, schools: [] });

  const sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_SCHOOLS);
  const values = sh.getDataRange().getValues();

  const out = [];
  for (let r = 1; r < values.length; r++) {
    const key = String(values[r][0] || "");
    const name = String(values[r][1] || "");
    const addr = String(values[r][2] || "");
    if (!key && !name) continue;

    const hay = (key + " " + name + " " + addr).toLowerCase();
    if (hay.indexOf(q) !== -1) {
      out.push({ key, name, extra: addr ? addr.slice(0, 14) : "" });
      if (out.length >= 20) break;
    }
  }

  return json_({ ok: true, schools: out });
}

/** 取得單一學校資料 */
function getSchool_(p) {
  const key = String(p.key || "").trim();
  if (!key) return json_({ ok: false, error: "Missing key" });

  const sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_SCHOOLS);
  const values = sh.getDataRange().getValues();
  const headers = values[0].map(String);

  for (let r = 1; r < values.length; r++) {
    if (String(values[r][0] || "").trim() === key) {
      const row = values[r];
      const get = (name) => {
        const c = idx_(headers, name);
        return c >= 0 ? row[c] : "";
      };

      return json_({
        ok: true,
        school: {
          key: String(get("SchoolKey") || ""),
          name: String(get("SchoolName") || ""),
          address: String(get("Address") || ""),
          contactName: String(get("ContactName") || ""),
          contactTitle: String(get("ContactTitle") || ""),
          phone: String(get("Phone") || ""),
          versionsJson: String(get("VersionsJSON") || ""),
          versionOther: String(get("VersionOther") || ""),
          lastUpdated: get("LastUpdated") ? fmt_(get("LastUpdated")) : "",
          lastModifiedBy: String(get("LastModifiedBy") || "")
        }
      });
    }
  }

  return json_({ ok: false, error: "School not found" });
}

/** 更新學校：覆蓋主資料；若 note 有值則追加 updates */
function updateSchool_(p) {
  const key = String(p.key || "").trim();
  const sales = String(p.salesPerson || "").trim();
  if (!sales) return json_({ ok: false, error: "Missing salesPerson" });
  if (!key) return json_({ ok: false, error: "Missing key" });

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SHEET_SCHOOLS);
  const up = ss.getSheetByName(SHEET_UPDATES);

  const values = sh.getDataRange().getValues();
  const headers = values[0].map(String);
  const now = new Date();

  for (let r = 1; r < values.length; r++) {
    if (String(values[r][0] || "").trim() === key) {
      const set = (name, val) => {
        const c = idx_(headers, name);
        if (c >= 0) sh.getRange(r + 1, c + 1).setValue(val);
      };

      set("SchoolName", String(p.name || "").trim());
      set("Address", String(p.address || "").trim());
      set("ContactName", String(p.contactName || "").trim());
      set("ContactTitle", String(p.contactTitle || "").trim());
      set("Phone", String(p.phone || "").trim());

      set("VersionsJSON", String(p.versionsJson || "").trim());
      set("VersionOther", String(p.versionOther || "").trim());

      set("LastUpdated", now);
      set("LastModifiedBy", sales);

      const note = String(p.note || "").trim();
      if (note) up.appendRow([now, key, String(p.name || ""), sales, note, "HTML"]);

      return json_({ ok: true });
    }
  }

  return json_({ ok: false, error: "School not found" });
}

/** 新增學校：若沒 key，後台自動產生；若 note 有值則追加 updates */
function createSchool_(p) {
  const sales = String(p.salesPerson || "").trim();
  const name = String(p.name || "").trim();
  if (!sales) return json_({ ok: false, error: "Missing salesPerson" });
  if (!name) return json_({ ok: false, error: "Missing name" });

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SHEET_SCHOOLS);
  const up = ss.getSheetByName(SHEET_UPDATES);

  const values = sh.getDataRange().getValues();
  const now = new Date();

  let key = String(p.key || "").trim();
  if (!key) key = Utilities.getUuid().replace(/-/g, "").slice(0, 10).toUpperCase();

  // key 不能重複
  for (let r = 1; r < values.length; r++) {
    if (String(values[r][0] || "").trim() === key) {
      return json_({ ok: false, error: "SchoolKey already exists" });
    }
  }

  sh.appendRow([
    key,
    name,
    String(p.address || "").trim(),
    String(p.contactName || "").trim(),
    String(p.contactTitle || "").trim(),
    String(p.phone || "").trim(),
    String(p.versionsJson || "").trim(),
    String(p.versionOther || "").trim(),
    now,
    sales
  ]);

  const note = String(p.note || "").trim();
  if (note) up.appendRow([now, key, name, sales, note, "HTML"]);

  return json_({ ok: true, key });
}

/** 從 versions 分頁回傳：分類 options + order（依 CategoryOrder/ItemOrder 排序） */
function getVersionOptions_() {
  const vs = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_VERSIONS);
  const values = vs.getDataRange().getValues();
  if (values.length <= 1) return json_({ ok: true, options: {}, order: [] });

  const headers = values[0].map(String);
  const cCat = idx_(headers, "Category");
  const cItem = idx_(headers, "Item");
  const cCO = idx_(headers, "CategoryOrder");
  const cIO = idx_(headers, "ItemOrder");

  const rows = [];
  for (let r = 1; r < values.length; r++) {
    const cat = String(values[r][cCat] || "").trim();
    const item = String(values[r][cItem] || "").trim();
    if (!cat || !item) continue;

    const co = Number(values[r][cCO] || 0);
    const io = Number(values[r][cIO] || 0);
    rows.push({ cat, item, co, io });
  }

  // 先依 category order，再依 item order
  rows.sort((a, b) => (a.co - b.co) || a.cat.localeCompare(b.cat) || (a.io - b.io) || a.item.localeCompare(b.item));

  const options = {};
  const orderMap = {};
  rows.forEach(x => {
    if (!options[x.cat]) options[x.cat] = [];
    options[x.cat].push(x.item);
    if (orderMap[x.cat] === undefined) orderMap[x.cat] = x.co;
  });

  // 產生分類 order（依 CategoryOrder）
  const order = Object.keys(options).sort((a, b) => (orderMap[a] - orderMap[b]) || a.localeCompare(b));

  return json_({ ok: true, options, order });
}
