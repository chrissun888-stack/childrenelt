<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>學校 CRM（搜尋/載入/更新/新增）</title>
  <style>
    /* ===== A 版型（固定） ===== */
    :root {
      --bg:#f6f7f9; --card:#fff; --border:#d8dde6; --text:#111827;
      --muted:#6b7280; --ok:#0a7a2f; --err:#b42318;
      --btn:#111827; --btnText:#fff; --ghost:#eef2f7;
      --shadow:0 6px 18px rgba(0,0,0,.06);
      --radius:14px;
    }

    body {
      font-family: system-ui,-apple-system,"Noto Sans TC","PingFang TC","Microsoft JhengHei",sans-serif;
      margin:0;background:var(--bg);color:var(--text);
    }
    .wrap { max-width: 1040px; margin: 0 auto; padding: 16px; }
    .card { background: var(--card); border-radius: var(--radius); padding: 16px; box-shadow: var(--shadow); border: 1px solid transparent; }
    h1 { font-size: 18px; margin: 0 0 10px; }
    .hint { font-size: 12px; color: var(--muted); margin: 0 0 12px; line-height: 1.5; }
    label { display:block; font-size: 13px; color: var(--text); margin: 10px 0 6px; opacity: .92; }
    input, select, textarea {
      width:100%; padding: 11px 12px; border:1px solid var(--border); border-radius:10px;
      font-size: 15px; background: transparent; color: var(--text); box-sizing: border-box;
      outline: none;
    }
    textarea { min-height: 96px; resize: vertical; }
    .grid { display:grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 860px){ .grid { grid-template-columns: 1fr 1fr; } }
    .row2 { grid-column: 1 / -1; }
    .actions { display:flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    button { padding: 12px 14px; border:0; border-radius: 12px; font-size: 16px; cursor:pointer; }
    .primary { background: var(--btn); color: var(--btnText); }
    .ghost { background: var(--ghost); color: var(--text); border: 1px solid var(--border); }
    .status { margin-top: 12px; font-size: 14px; }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    .suggest { position: relative; }
    .suggest-list {
      position:absolute; left:0; right:0; top: 100%;
      background:var(--card); border:1px solid var(--border); border-radius: 12px;
      margin-top: 6px; max-height: 240px; overflow:auto; z-index: 10;
      box-shadow: var(--shadow);
      display:none;
    }
    .suggest-item { padding: 10px 12px; cursor:pointer; border-bottom: 1px solid rgba(229,231,235,.35); }
    .suggest-item:last-child { border-bottom: 0; }
    .suggest-item:hover { background: rgba(148,163,184,.18); }
    .pill { display:inline-block; font-size: 12px; padding: 2px 8px; border-radius: 999px; background: rgba(148,163,184,.18); color: var(--text); margin-left:8px; }
    .readonly { background: rgba(148,163,184,.12); }
    .bar { display:flex; gap: 10px; flex-wrap: wrap; }
    .bar > div { flex: 1; min-width: 220px; }
    .mode { display:flex; gap:10px; align-items:center; flex-wrap: wrap; }
    .mode span { font-size: 12px; color: var(--muted); }
    .subhead { margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(229,231,235,.35); }
    .subhead h2 { font-size: 14px; margin: 0 0 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>學校 CRM（搜尋/載入/更新/新增）</h1>
      <p class="hint">
        1-5（含聯絡人職位）與「版本表」會覆蓋更新到 schools。<br/>
        「需求/進度更新」每次儲存都會新增一筆到 updates（留歷史）。<br/>
        「版本表選項」由後台 versions 工作表提供，可在後台直接改分類/書名/順序。
      </p>

      <div class="bar">
        <div>
          <label>業務（必選）</label>
          <select id="salesPerson">
            <option value="">請選擇</option>
            <option>全區 - Ken</option>
            <option>北區 - Chris</option>
            <option>中區 - Tania</option>
            <option>南區 - Sonia</option>
          </select>
        </div>
      </div>

      <div class="bar">
        <div>
          <label>模式</label>
          <div class="mode">
            <button class="ghost" id="modeSearchBtn" type="button">搜尋既有學校</button>
            <button class="ghost" id="modeNewBtn" type="button">新增新客戶</button>
            <span id="modeText">目前：搜尋既有學校</span>
          </div>
        </div>
      </div>

      <div id="searchBlock">
        <label>搜尋學校（輸入關鍵字）</label>
        <div class="suggest">
          <input id="schoolSearch" placeholder="例如：ABC、美語、國小…（輸入 A 也可）" autocomplete="off" />
          <div id="suggestList" class="suggest-list"></div>
        </div>
      </div>

      <div class="grid" style="margin-top: 6px;">
        <div>
          <label>1. 學校代號</label>
          <input id="schoolKey" class="readonly" readonly placeholder="選擇學校後自動帶入（新增模式會自動產生）" />
        </div>
        <div>
          <label>2. 學校名稱</label>
          <input id="schoolName" placeholder="例如：ABC 美語" />
        </div>

        <div class="row2">
          <label>3. 學校地址</label>
          <input id="address" placeholder="例如：台北市..." />
        </div>

        <div>
          <label>4. 聯絡人</label>
          <input id="contactName" placeholder="例如：王主任" />
        </div>
        <div>
          <label>聯絡人職位</label>
          <select id="contactTitle">
            <option value="">—</option>
            <option>校長</option>
            <option>主任</option>
            <option>組長</option>
            <option>英文老師</option>
            <option value="__other__">其他（自行輸入）</option>
          </select>
          <input id="contactTitleOther" style="display:none; margin-top:8px;" placeholder="請輸入職位" />
        </div>

        <div>
          <label>5. 電話</label>
          <input id="phone" inputmode="tel" placeholder="可留空" />
        </div>
        <div>
          <label>最後更新時間</label>
          <input id="lastUpdated" class="readonly" readonly />
        </div>

        <div>
          <label>最後更新業務</label>
          <input id="lastModifiedBy" class="readonly" readonly />
        </div>
      </div>

      <div class="subhead">
        <h2>學校使用版本表（由後台 versions 控制分類/書名/順序）</h2>
        <p class="hint">每一類：下拉選擇（含「其他」可手寫）。</p>
        <div class="grid" id="versionsGrid"></div>

        <div class="row2" style="margin-top:12px">
          <label>其他（補充）</label>
          <input id="versionOther" placeholder="例如：口說/字彙/文法/考試/數位…" />
        </div>
      </div>

      <div class="subhead">
        <h2>6. 該校需求/進度更新（每次儲存都會留下紀錄）</h2>
        <textarea id="note" placeholder="例如：需要樣書 Starter~3；下週二試教；需報價單"></textarea>
      </div>

      <div class="actions">
        <button class="primary" id="saveBtn" type="button">儲存</button>
        <button class="ghost" id="clearBtn" type="button">清空</button>
      </div>

      <div class="status" id="status"></div>
      <p class="hint">提示：若版本表沒出現，通常是 Web App 權限或後台尚未更新部署。</p>
    </div>
  </div>

<script>
  // ===== 你只要確認這兩行 =====
  const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzNGYpwRY73uoicr_a6IJjNeHILG_8X3jbE_s9o6EOIAlMc4Vrm9SE6dUQ8lwq9_SILvQ/exec";
  const TOKEN = "abc123";
  // ============================

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const suggestList = $("suggestList");
  let debounceTimer = null;
  let mode = "search";

  // 後台 versions 載入後會覆寫這兩個
  window.VERSION_OPTIONS = {};
  window.VERSION_ORDER = [];

  function setStatus(msg, type="") {
    statusEl.textContent = msg || "";
    statusEl.className = "status " + type;
  }

  function requireSales() {
    const s = $("salesPerson").value.trim();
    if (!s) { setStatus("請先選擇業務", "err"); return ""; }
    return s;
  }

  function hideSuggest() { suggestList.style.display = "none"; }

  function showSuggest(items) {
    suggestList.innerHTML = "";
    if (!items || items.length === 0) { hideSuggest(); return; }
    items.forEach(it => {
      const div = document.createElement("div");
      div.className = "suggest-item";
      div.textContent = it.name || "";
      if (it.extra) {
        const span = document.createElement("span");
        span.className = "pill";
        span.textContent = it.extra;
        div.appendChild(span);
      }
      div.onclick = () => selectSchool(it);
      suggestList.appendChild(div);
    });
    suggestList.style.display = "block";
  }

  async function post(action, data) {
    const payload = { token: TOKEN, action, ...data };
    const res = await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload),
    });

    const text = await res.text();
    try { return JSON.parse(text); }
    catch (e) {
      return { ok:false, error:"Non-JSON response. HTTP=" + res.status + " Body=" + text.slice(0, 200) };
    }
  }

  async function getVersionOptions() { return await post("getVersionOptions", {}); }
  async function searchSchools(q)     { return await post("searchSchools", { q }); }
  async function getSchool(key)       { return await post("getSchool", { key }); }
  async function updateSchool(data)   { return await post("updateSchool", data); }
  async function createSchool(data)   { return await post("createSchool", data); }

  function setMode(m) {
    mode = m;
    $("modeText").textContent = m === "new" ? "目前：新增新客戶" : "目前：搜尋既有學校";
    $("searchBlock").style.display = m === "search" ? "block" : "none";
    if (m === "new") {
      clearForm(false);
      setStatus("新增模式：請手動填寫學校資料後儲存。");
    } else {
      setStatus("");
    }
  }

  $("modeSearchBtn").addEventListener("click", () => setMode("search"));
  $("modeNewBtn").addEventListener("click", () => setMode("new"));

  $("schoolSearch").addEventListener("input", () => {
    if (mode !== "search") return;
    if (!requireSales()) return;

    const q = $("schoolSearch").value.trim();
    clearTimeout(debounceTimer);
    if (!q) { hideSuggest(); return; }

    debounceTimer = setTimeout(async () => {
      try {
        const r = await searchSchools(q);
        if (!r || !r.ok) throw new Error(r?.error || "搜尋失敗");
        showSuggest((r.schools || []).slice(0, 20));
      } catch (e) {
        hideSuggest();
        setStatus("搜尋失敗：" + String(e), "err");
      }
    }, 220);
  });

  document.addEventListener("click", (e) => {
    if (!e.target.closest(".suggest")) hideSuggest();
  });

  // 聯絡人職位「其他」
  $("contactTitle").addEventListener("change", () => {
    if ($("contactTitle").value === "__other__") {
      $("contactTitleOther").style.display = "block";
      $("contactTitleOther").required = true;
    } else {
      $("contactTitleOther").style.display = "none";
      $("contactTitleOther").required = false;
      $("contactTitleOther").value = "";
    }
  });

  // ===== 版本表 UI（動態 from 後台）=====
  function safeId(cat) {
    return "v_" + btoa(unescape(encodeURIComponent(cat)))
      .replaceAll("=", "").replaceAll("+", "_").replaceAll("/", "_");
  }

  function renderVersionFields() {
    const grid = $("versionsGrid");
    grid.innerHTML = "";

    const order = window.VERSION_ORDER || [];
    const options = window.VERSION_OPTIONS || {};

    order.forEach(cat => {
      const id = safeId(cat);
      const otherId = id + "_other";

      const block = document.createElement("div");
      block.innerHTML = `
        <label>${cat}</label>
        <select id="${id}"></select>
        <input id="${otherId}" style="display:none; margin-top:8px;" placeholder="${cat}：其他請輸入" />
      `;
      grid.appendChild(block);

      const sel = $(id);
      sel.appendChild(new Option("—", ""));

      ((options && options[cat]) ? options[cat] : ["（其他）"]).forEach(o => {
        if (o === "（其他）") sel.appendChild(new Option("其他（自行輸入）", "__other__"));
        else sel.appendChild(new Option(o, o));
      });

      sel.addEventListener("change", () => {
        const other = $(otherId);
        if (sel.value === "__other__") {
          other.style.display = "block";
          other.required = true;
        } else {
          other.style.display = "none";
          other.required = false;
          other.value = "";
        }
      });
    });
  }

  function getVersionValue(cat) {
    const id = safeId(cat);
    const sel = $(id);
    const other = $(id + "_other");
    if (!sel) return "";
    return sel.value === "__other__" ? (other.value || "").trim() : (sel.value || "").trim();
  }

  function setVersionValueByCat(cat, val) {
    const id = safeId(cat);
    const sel = $(id);
    const other = $(id + "_other");
    if (!sel) return;

    if (!val) {
      sel.value = "";
      other.style.display = "none";
      other.value = "";
      other.required = false;
      return;
    }

    const opts = Array.from(sel.options).map(o => o.value);
    if (opts.includes(val)) {
      sel.value = val;
      other.style.display = "none";
      other.value = "";
      other.required = false;
    } else {
      sel.value = "__other__";
      other.style.display = "block";
      other.value = val;
      other.required = true;
    }
  }

  function buildVersionsPayload() {
    const versions = {};
    (window.VERSION_ORDER || []).forEach(cat => versions[cat] = getVersionValue(cat));
    return versions;
  }
  // ======================================

  async function selectSchool(it) {
    hideSuggest();
    $("schoolSearch").value = it.name || "";
    setStatus("載入資料…");
    try {
      const r = await getSchool(it.key);
      if (!r || !r.ok) throw new Error(r?.error || "載入失敗");
      const s = r.school || {};

      $("schoolKey").value = s.key || it.key || "";
      $("schoolName").value = s.name || it.name || "";
      $("address").value = s.address || "";
      $("contactName").value = s.contactName || "";

      const title = s.contactTitle || "";
      if (["校長","主任","組長","英文老師"].includes(title)) {
        $("contactTitle").value = title;
        $("contactTitleOther").style.display = "none";
        $("contactTitleOther").value = "";
        $("contactTitleOther").required = false;
      } else if (title) {
        $("contactTitle").value = "__other__";
        $("contactTitleOther").style.display = "block";
        $("contactTitleOther").value = title;
        $("contactTitleOther").required = true;
      } else {
        $("contactTitle").value = "";
        $("contactTitleOther").style.display = "none";
        $("contactTitleOther").value = "";
        $("contactTitleOther").required = false;
      }

      $("phone").value = s.phone || "";

      // 版本表：後台用 JSON 字串存
      let versions = {};
      try { versions = s.versionsJson ? JSON.parse(s.versionsJson) : {}; } catch(e) { versions = {}; }
      (window.VERSION_ORDER || []).forEach(cat => setVersionValueByCat(cat, versions[cat] || ""));

      $("versionOther").value = s.versionOther || "";
      $("lastUpdated").value = s.lastUpdated || "";
      $("lastModifiedBy").value = s.lastModifiedBy || "";
      $("note").value = "";

      setStatus("已載入，可更新並儲存。", "ok");
    } catch (e) {
      setStatus("載入失敗：" + String(e), "err");
    }
  }

  function clearForm(clearSales=true) {
    if (clearSales) $("salesPerson").value = "";
    $("schoolSearch").value = "";
    $("schoolKey").value = "";
    $("schoolName").value = "";
    $("address").value = "";
    $("contactName").value = "";
    $("contactTitle").value = "";
    $("contactTitleOther").style.display = "none";
    $("contactTitleOther").value = "";
    $("contactTitleOther").required = false;
    $("phone").value = "";

    (window.VERSION_ORDER || []).forEach(cat => {
      const id = safeId(cat);
      const sel = $(id);
      const other = $(id + "_other");
      if (sel) sel.value = "";
      if (other) {
        other.style.display = "none";
        other.value = "";
        other.required = false;
      }
    });
    $("versionOther").value = "";

    $("note").value = "";
    $("lastUpdated").value = "";
    $("lastModifiedBy").value = "";
    hideSuggest();
  }

  $("saveBtn").addEventListener("click", async () => {
    const sales = requireSales();
    if (!sales) return;

    const name = $("schoolName").value.trim();
    if (!name) { setStatus("請填寫學校名稱", "err"); return; }

    // 防呆：搜尋模式下沒有 key 就不能更新
    if (mode !== "new" && !$("schoolKey").value.trim()) {
      setStatus("請先從搜尋結果點選一間學校（帶入學校代號），或改用「新增新客戶」。", "err");
      return;
    }

    const title = ($("contactTitle").value === "__other__")
      ? $("contactTitleOther").value.trim()
      : $("contactTitle").value.trim();

    const payload = {
      salesPerson: sales,
      key: $("schoolKey").value.trim(),
      name,
      address: $("address").value.trim(),
      contactName: $("contactName").value.trim(),
      contactTitle: title,
      phone: $("phone").value.trim(),
      versionsJson: JSON.stringify(buildVersionsPayload()),
      versionOther: $("versionOther").value.trim(),
      note: $("note").value.trim()
    };

    setStatus("儲存中…");
    try {
      let r;
      if (mode === "new") r = await createSchool(payload);
      else r = await updateSchool(payload);

      if (!r || !r.ok) throw new Error(r?.error || "儲存失敗");
      if (r.key) $("schoolKey").value = r.key;

      // 重新抓一次，更新 lastUpdated/lastModifiedBy
      const key = $("schoolKey").value.trim();
      if (key) {
        const rr = await getSchool(key);
        if (rr && rr.ok && rr.school) {
          $("lastUpdated").value = rr.school.lastUpdated || "";
          $("lastModifiedBy").value = rr.school.lastModifiedBy || sales;
        }
      }

      $("note").value = "";
      if (mode === "new") setMode("search");

      setStatus("已儲存。", "ok");
    } catch (e) {
      setStatus("儲存失敗：" + String(e), "err");
    }
  });

  $("clearBtn").addEventListener("click", () => {
    clearForm(true);
    setStatus("");
  });

  // ===== 初始化：先向後台載入 versions 清單（分類/書名/順序）=====
  (async function init() {
    setStatus("載入版本表清單…");
    try {
      const r = await getVersionOptions();
      if (!r || !r.ok) throw new Error(r?.error || "載入版本表失敗");

      window.VERSION_OPTIONS = r.options || {};
      window.VERSION_ORDER = (r.order && r.order.length) ? r.order : [];

      if (!window.VERSION_ORDER.length) {
        setStatus("版本表清單是空的：請到試算表 versions 工作表新增 Category/Item/順序。", "err");
      } else {
        setStatus("");
      }

      renderVersionFields();
      setMode("search");
    } catch (e) {
      window.VERSION_OPTIONS = {};
      window.VERSION_ORDER = [];
      renderVersionFields();
      setMode("search");
      setStatus("版本表清單載入失敗：" + String(e), "err");
    }
  })();
</script>
</body>
</html>
