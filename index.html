/**
 * 學校 CRM 後台（Apps Script / Code.gs）— 完整版（versions 可控制分類/書名/順序）
 */

const TOKEN = "abc123";

const SHEET_SCHOOLS  = "schools";
const SHEET_UPDATES  = "updates";
const SHEET_VERSIONS = "versions";

function doGet() {
  return ContentService.createTextOutput("School CRM backend is running.");
}

function doPost(e) {
  try {
    const body = (e && e.postData && e.postData.contents) ? e.postData.contents : "{}";
    const p = JSON.parse(body);

    if (!p || p.token !== TOKEN) return json_({ ok: false, error: "Unauthorized" });

    ensureSheets_();

    const action = String(p.action || "");
    if (action === "getVersionOptions") return getVersionOptions_();
    if (action === "searchSchools")     return searchSchools_(p);
    if (action === "getSchool")         return getSchool_(p);
    if (action === "updateSchool")      return updateSchool_(p);
    if (action === "createSchool")      return createSchool_(p);

    return json_({ ok: false, error: "Unknown action: " + action });
  } catch (err) {
    return json_({ ok: false, error: String(err) });
  }
}

function ensureSheets_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();

  let sh = ss.getSheetByName(SHEET_SCHOOLS);
  if (!sh) sh = ss.insertSheet(SHEET_SCHOOLS);

  let up = ss.getSheetByName(SHEET_UPDATES);
  if (!up) up = ss.insertSheet(SHEET_UPDATES);

  let vs = ss.getSheetByName(SHEET_VERSIONS);
  if (!vs) vs = ss.insertSheet(SHEET_VERSIONS);

  const hSchools = [
    "SchoolKey","SchoolName","Address","ContactName","ContactTitle","Phone",
    "VersionsJSON","VersionOther",
    "LastUpdated","LastModifiedBy"
  ];
  const hUpdates = ["Timestamp","SchoolKey","SchoolName","SalesPerson","Note","Source"];

  // versions：新增排序欄
  const hVersions = ["Category","Item","CategoryOrder","ItemOrder"];

  if (sh.getLastRow() === 0) sh.appendRow(hSchools);
  if (up.getLastRow() === 0) up.appendRow(hUpdates);
  if (vs.getLastRow() === 0) vs.appendRow(hVersions);

  // 補齊 schools 欄位
  const existing = sh.getRange(1, 1, 1, sh.getLastColumn()).getValues()[0].map(String);
  hSchools.forEach((h) => {
    if (existing.indexOf(h) === -1) {
      sh.insertColumnAfter(sh.getLastColumn());
      sh.getRange(1, sh.getLastColumn()).setValue(h);
      existing.push(h);
    }
  });

  // 確保 versions 標題為 4 欄（不足就補）
  const lastCol = Math.max(4, vs.getLastColumn());
  const headers = vs.getRange(1, 1, 1, lastCol).getValues()[0].map(String);
  // 若前兩欄不是 Category/Item，直接重寫前四欄標題
  if (headers[0] !== "Category" || headers[1] !== "Item") {
    vs.getRange(1, 1, 1, 4).setValues([hVersions]);
  } else {
    // 補第三、四欄標題
    if (headers[2] !== "CategoryOrder") vs.getRange(1, 3).setValue("CategoryOrder");
    if (headers[3] !== "ItemOrder") vs.getRange(1, 4).setValue("ItemOrder");
  }
}

function idx_(headers, name) {
  const i = headers.indexOf(name);
  return i >= 0 ? i : -1;
}

function json_(obj) {
  return ContentService
    .createTextOutput(JSON.stringify(obj))
    .setMimeType(ContentService.MimeType.JSON);
}

function fmt_(d) {
  return Utilities.formatDate(new Date(d), Session.getScriptTimeZone(), "yyyy-MM-dd HH:mm");
}

/**
 * 版本表：支援「分類/書名/順序」
 * versions 表格欄位：
 * A Category
 * B Item
 * C CategoryOrder（數字，小的在前）
 * D ItemOrder（數字，小的在前）
 */
function getVersionOptions_() {
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const vs = ss.getSheetByName(SHEET_VERSIONS);

  const values = vs.getDataRange().getValues();
  if (!values || values.length <= 1) return json_({ ok: true, options: {}, order: [] });

  // 收集所有列
  const rows = [];
  for (let r = 1; r < values.length; r++) {
    const cat = String(values[r][0] || "").trim();
    const item = String(values[r][1] || "").trim();
    if (!cat || !item) continue;

    const catOrder = toNumber_(values[r][2], 999999);
    const itemOrder = toNumber_(values[r][3], 999999);

    rows.push({ cat, item, catOrder, itemOrder });
  }

  // 先依分類順序→分類名，再依 itemOrder→item 名排序
  rows.sort((a, b) => {
    if (a.catOrder !== b.catOrder) return a.catOrder - b.catOrder;
    if (a.cat !== b.cat) return a.cat.localeCompare(b.cat, "zh-Hant");
    if (a.itemOrder !== b.itemOrder) return a.itemOrder - b.itemOrder;
    return a.item.localeCompare(b.item, "zh-Hant");
  });

  const options = {};
  const order = [];

  rows.forEach(({ cat, item }) => {
    if (!options[cat]) {
      options[cat] = [];
      order.push(cat);
    }
    if (options[cat].indexOf(item) === -1) options[cat].push(item);
  });

  // 每分類最後補「（其他）」
  order.forEach((cat) => {
    if (options[cat].indexOf("（其他）") === -1) options[cat].push("（其他）");
  });

  return json_({ ok: true, options, order });
}

function toNumber_(v, fallback) {
  const n = Number(v);
  return Number.isFinite(n) ? n : fallback;
}

function searchSchools_(p) {
  const q = String(p.q || "").trim().toLowerCase();
  if (!q) return json_({ ok: true, schools: [] });

  const sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_SCHOOLS);
  const values = sh.getDataRange().getValues();

  const out = [];
  for (let r = 1; r < values.length; r++) {
    const key = String(values[r][0] || "");
    const name = String(values[r][1] || "");
    const addr = String(values[r][2] || "");
    if (!key && !name) continue;

    const hay = (key + " " + name + " " + addr).toLowerCase();
    if (hay.indexOf(q) !== -1) {
      out.push({ key, name, extra: addr ? addr.slice(0, 14) : "" });
      if (out.length >= 20) break;
    }
  }
  return json_({ ok: true, schools: out });
}

function getSchool_(p) {
  const key = String(p.key || "").trim();
  if (!key) return json_({ ok: false, error: "Missing key" });

  const sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(SHEET_SCHOOLS);
  const values = sh.getDataRange().getValues();
  const headers = values[0].map(String);

  for (let r = 1; r < values.length; r++) {
    if (String(values[r][0] || "").trim() === key) {
      const row = values[r];
      const get = (name) => {
        const c = idx_(headers, name);
        return c >= 0 ? row[c] : "";
      };

      return json_({
        ok: true,
        school: {
          key: String(get("SchoolKey") || ""),
          name: String(get("SchoolName") || ""),
          address: String(get("Address") || ""),
          contactName: String(get("ContactName") || ""),
          contactTitle: String(get("ContactTitle") || ""),
          phone: String(get("Phone") || ""),
          versionsJson: String(get("VersionsJSON") || ""),
          versionOther: String(get("VersionOther") || ""),
          lastUpdated: get("LastUpdated") ? fmt_(get("LastUpdated")) : "",
          lastModifiedBy: String(get("LastModifiedBy") || "")
        }
      });
    }
  }

  return json_({ ok: false, error: "School not found" });
}

function updateSchool_(p) {
  const key = String(p.key || "").trim();
  const sales = String(p.salesPerson || "").trim();
  if (!sales) return json_({ ok: false, error: "Missing salesPerson" });
  if (!key) return json_({ ok: false, error: "Missing key" });

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SHEET_SCHOOLS);
  const up = ss.getSheetByName(SHEET_UPDATES);

  const values = sh.getDataRange().getValues();
  const headers = values[0].map(String);
  const now = new Date();

  for (let r = 1; r < values.length; r++) {
    if (String(values[r][0] || "").trim() === key) {
      const set = (name, val) => {
        const c = idx_(headers, name);
        if (c >= 0) sh.getRange(r + 1, c + 1).setValue(val);
      };

      set("SchoolName", String(p.name || "").trim());
      set("Address", String(p.address || "").trim());
      set("ContactName", String(p.contactName || "").trim());
      set("ContactTitle", String(p.contactTitle || "").trim());
      set("Phone", String(p.phone || "").trim());
      set("VersionsJSON", String(p.versionsJson || "").trim());
      set("VersionOther", String(p.versionOther || "").trim());
      set("LastUpdated", now);
      set("LastModifiedBy", sales);

      const note = String(p.note || "").trim();
      if (note) up.appendRow([now, key, String(p.name || ""), sales, note, "HTML"]);

      return json_({ ok: true });
    }
  }
  return json_({ ok: false, error: "School not found" });
}

function createSchool_(p) {
  const sales = String(p.salesPerson || "").trim();
  const name = String(p.name || "").trim();
  if (!sales) return json_({ ok: false, error: "Missing salesPerson" });
  if (!name) return json_({ ok: false, error: "Missing name" });

  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sh = ss.getSheetByName(SHEET_SCHOOLS);
  const up = ss.getSheetByName(SHEET_UPDATES);

  const values = sh.getDataRange().getValues();
  const now = new Date();

  let key = String(p.key || "").trim();
  if (!key) key = Utilities.getUuid().replace(/-/g, "").slice(0, 10).toUpperCase();

  for (let r = 1; r < values.length; r++) {
    if (String(values[r][0] || "").trim() === key) {
      return json_({ ok: false, error: "SchoolKey already exists" });
    }
  }

  sh.appendRow([
    key,
    name,
    String(p.address || "").trim(),
    String(p.contactName || "").trim(),
    String(p.contactTitle || "").trim(),
    String(p.phone || "").trim(),
    String(p.versionsJson || "").trim(),
    String(p.versionOther || "").trim(),
    now,
    sales
  ]);

  const note = String(p.note || "").trim();
  if (note) up.appendRow([now, key, name, sales, note, "HTML"]);

  return json_({ ok: true, key });
}
